<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Reclutamiento con IA - Grupo Norte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { max-height: 90vh; overflow-y: auto; }
    .ai-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .ai-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.7;} }
  </style>
</head>
<body class="min-h-screen" style="background-color:#002338;">

<header class="w-full py-4" style="background-color:#002338;">
  <div class="max-w-5xl mx-auto flex justify-center items-center gap-6">
    <img src="https://github.com/AnalistaGn/dashboard-gn-e/blob/main/Grupo%20%5E%20Norte_%20Creamos%20.png?raw=true" alt="Grupo Norte" class="h-16 object-contain" />
    <img src="https://github.com/AnalistaGn/dashboard-gn-e/blob/main/Norti%CC%81n%20Verde.png?raw=true" alt="NortÃ­n Verde" class="h-16 object-contain" />
  </div>
</header>

<main class="max-w-6xl mx-auto bg-white shadow-lg rounded-xl p-6 mt-6">
  <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">ðŸ“‹ Sistema de Reclutamiento con IA</h1>

  <!-- Buscador -->
  <div class="mb-6 flex gap-2">
    <input id="searchInput" type="text" placeholder="Escribe nombre, RUT, cargo, email, telÃ©fono, comuna, empresa o fecha..." class="flex-grow p-3 border rounded-lg focus:ring focus:ring-green-300" />
    <button id="searchBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">Buscar</button>
    <button id="smartSearchBtn" class="ai-gradient text-white px-6 py-2 rounded">IA</button>
  </div>

  <!-- Resultados -->
  <div class="bg-gray-50 rounded-lg p-4 mb-6">
    <h2 class="text-xl font-bold mb-4 text-gray-800">Candidatos Encontrados</h2>
    <div id="results" class="space-y-3"></div>
  </div>

  <!-- Historial -->
  <div id="historialSection" class="bg-gray-50 rounded-lg p-4 hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800">ðŸ“Š Historial de Gestiones</h2>
      <div class="flex gap-2">
        <button id="downloadExcelBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">ðŸ“Š Descargar Excel</button>
        <button id="downloadPdfBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">ðŸ“„ Descargar PDF</button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm bg-white rounded-lg shadow">
        <thead class="bg-gray-200"><tr><th class="p-3">Nombre</th><th class="p-3">RUT</th><th class="p-3">Cargo</th><th class="p-3">Estado</th><th class="p-3">Motivo</th><th class="p-3">Fecha/Hora</th><th class="p-3">Score IA</th></tr></thead>
        <tbody id="historialBody"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Modal Ficha -->
<div id="modalFicha" class="modal-overlay hidden">
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full modal-content">
    <h2 class="text-xl font-bold mb-4">ðŸ“„ Ficha de PostulaciÃ³n</h2>
    <div id="fichaContent" class="space-y-2"></div>
    <div class="flex justify-end mt-4 gap-2">
      <button onclick="downloadFichaPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">ðŸ“„ Imprimir Ficha</button>
      <button onclick="closeFicha()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Cerrar</button>
    </div>
  </div>
</div>

<script>
const SHEETDB_API_URL = "https://sheetdb.io/api/v1/arqvckj0fb8af";
let gestiones = [], currentCandidates = [];

async function searchCandidates(q){try{const r=await fetch(SHEETDB_API_URL);const all=await r.json();const s=q.trim().toLowerCase();const f=all.filter(c=>[c.NOMBRE,c.APELLIDO,c.RUT,c.CARGO,c.EMAIL,c.TELEFONO,c["FECHA DE POSTULACION"],c.COMUNA,c.EMPRESA].some(v=>v&&v.toLowerCase().includes(s)));currentCandidates=f;renderResults(f);}catch(e){alert("Error bÃºsqueda: "+e.message);}}

async function smartSearch(){const q=document.getElementById("searchInput").value;if(q.length<2){alert("Escribe al menos 2 caracteres");return;}try{const r=await fetch(SHEETDB_API_URL);const all=await r.json();const s=q.trim().toLowerCase();let scored=all.map(c=>{let score=0;[c.NOMBRE,c.APELLIDO,c.RUT,c.CARGO,c.EMAIL,c.TELEFONO,c["FECHA DE POSTULACION"],c.COMUNA,c.EMPRESA].forEach(v=>{if(v&&v.toLowerCase().includes(s))score+=1;});return {...c,score};});scored=scored.filter(c=>c.score>0).sort((a,b)=>b.score-a.score);currentCandidates=scored;renderResults(scored,true);}catch(e){alert("Error IA: "+e.message);}}

function renderResults(data,isIA=false){const d=document.getElementById("results");d.innerHTML="";if(!data.length){d.innerHTML="<p>No hay resultados</p>";return;}data.forEach(c=>{const card=document.createElement("div");card.className="p-4 rounded-lg shadow-sm text-white cursor-pointer";card.style.background="#77c25c";card.innerHTML=`<p><b>${c.NOMBRE||''} ${c.APELLIDO||''}</b> - ${c.CARGO||''}</p><p>${c.RUT||''} | ${c.EMAIL||''}</p>${isIA?`<p><b>Score IA:</b> ${c.score}</p>`:''}`;card.onclick=()=>openFicha(c);d.appendChild(card);addHistorial(c,isIA?c.score:"");});document.getElementById("historialSection").classList.remove("hidden");}

function addHistorial(c,scoreIA){const body=document.getElementById("historialBody");const row=document.createElement("tr");row.innerHTML=`<td class='p-2'>${c.NOMBRE||''} ${c.APELLIDO||''}</td><td class='p-2'>${c.RUT||''}</td><td class='p-2'>${c.CARGO||''}</td><td class='p-2'>-</td><td class='p-2'>-</td><td class='p-2'>${new Date().toLocaleString()}</td><td class='p-2'>${scoreIA}</td>`;body.appendChild(row);gestiones.push({Nombre:c.NOMBRE||'',RUT:c.RUT||'',Cargo:c.CARGO||'',Estado:'-',Motivo:'-',FechaHora:new Date().toLocaleString(),ScoreIA:scoreIA});}

// Modal Ficha
function openFicha(c){document.getElementById("modalFicha").classList.remove("hidden");document.getElementById("fichaContent").innerHTML=`<p><b>Nombre:</b> ${c.NOMBRE||''} ${c.APELLIDO||''}</p><p><b>RUT:</b> ${c.RUT||''}</p><p><b>Cargo:</b> ${c.CARGO||''}</p><p><b>Email:</b> ${c.EMAIL||''}</p><p><b>TelÃ©fono:</b> ${c.TELEFONO||''}</p><p><b>Comuna:</b> ${c.COMUNA||''}</p><p><b>Empresa:</b> ${c.EMPRESA||''}</p><p><b>Fecha de PostulaciÃ³n:</b> ${c["FECHA DE POSTULACION"]||''}</p>`;}
function closeFicha(){document.getElementById("modalFicha").classList.add("hidden");}
async function downloadFichaPDF(){const { jsPDF } = window.jspdf;const doc=new jsPDF();await html2canvas(document.getElementById("fichaContent")).then(c=>{const img=c.toDataURL("image/png");doc.addImage(img,"PNG",10,10,180,0);doc.save("ficha_postulacion.pdf");});}

// Excel y PDF historial
function downloadExcel(){if(!gestiones.length){alert("No hay datos");return;}const ws=XLSX.utils.json_to_sheet(gestiones);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Historial");XLSX.writeFile(wb,"historial.xlsx");}
async function downloadPDF(){if(!gestiones.length){alert("No hay datos");return;}const { jsPDF } = window.jspdf;const doc=new jsPDF();await html2canvas(document.getElementById("historialSection")).then(c=>{const img=c.toDataURL("image/png");doc.addImage(img,"PNG",10,10,190,0);doc.save("historial.pdf");});}

document.getElementById("searchBtn").addEventListener("click",()=>{const q=document.getElementById("searchInput").value;if(q.length>=2)searchCandidates(q);});
document.getElementById("searchInput").addEventListener("keydown",e=>{if(e.key==="Enter")document.getElementById("searchBtn").click();});
document.getElementById("smartSearchBtn").addEventListener("click",smartSearch);
document.getElementById("downloadExcelBtn").addEventListener("click",downloadExcel);
document.getElementById("downloadPdfBtn").addEventListener("click",downloadPDF);
</script>

</body>
</html>
