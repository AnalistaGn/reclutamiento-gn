<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Reclutamiento con IA - Grupo Norte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      max-height: 90vh;
      overflow-y: auto;
    }
    .ai-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .ai-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .7; }
    }
    .thinking {
      border: 2px solid #667eea;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen" style="background-color:#002338;">

  <header class="w-full py-4" style="background-color:#002338;">
    <div class="max-w-5xl mx-auto flex justify-center items-center gap-6">
      <img src="https://github.com/AnalistaGn/dashboard-gn-e/blob/main/Grupo%20%5E%20Norte_%20Creamos%20.png?raw=true" 
           alt="Grupo Norte" class="h-16 object-contain" />
      <img src="https://github.com/AnalistaGn/dashboard-gn-e/blob/main/Norti%CC%81n%20Verde.png?raw=true" 
           alt="Nortín Verde" class="h-16 object-contain" />
    </div>
  </header>

  <main class="max-w-6xl mx-auto bg-white shadow-lg rounded-xl p-6 mt-6">
    <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">Sistema de Reclutamiento con IA</h1>

    <!-- Panel de IA -->
    <div class="ai-gradient rounded-lg mb-4 overflow-hidden shadow-lg">
      <div class="p-3 cursor-pointer flex justify-between items-center" onclick="toggleAIPanel()">
        <div class="flex items-center gap-3">
          <div class="w-6 h-6 bg-white rounded-full ai-pulse flex items-center justify-center">
            <span class="text-purple-600 text-sm font-bold">AI</span>
          </div>
          <h3 class="font-bold text-white">Asistente de IA para Reclutamiento</h3>
        </div>
        <span id="aiArrow" class="transform transition-transform text-white">▼</span>
      </div>
      <div id="aiContent" class="p-4 bg-white hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- Análisis de Candidatos -->
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border">
            <h4 class="font-bold text-blue-800 mb-2 flex items-center gap-2">
              <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
              Análisis de Candidatos
            </h4>
            <p class="text-sm text-blue-700 mb-3">La IA analiza automáticamente los perfiles y recomienda los mejores candidatos.</p>
            <button onclick="analyzeAllCandidates()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm w-full">
              Analizar Candidatos Actuales
            </button>
          </div>

          <!-- Generación de Preguntas -->
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border">
            <h4 class="font-bold text-green-800 mb-2 flex items-center gap-2">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              Preguntas de Entrevista
            </h4>
            <p class="text-sm text-green-700 mb-3">Genera preguntas personalizadas para cada candidato y puesto.</p>
            <button onclick="generateInterviewQuestions()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full">
              Generar Preguntas
            </button>
          </div>

          <!-- Evaluación de CV -->
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border">
            <h4 class="font-bold text-purple-800 mb-2 flex items-center gap-2">
              <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
              Evaluación de CV
            </h4>
            <p class="text-sm text-purple-700 mb-3">Analiza CVs y extrae información clave automáticamente.</p>
            <input type="file" id="cvFile" accept=".pdf,.doc,.docx" class="hidden">
            <button onclick="document.getElementById('cvFile').click()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm w-full">
              Subir y Analizar CV
            </button>
          </div>

          <!-- Chat con IA -->
          <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border">
            <h4 class="font-bold text-orange-800 mb-2 flex items-center gap-2">
              <span class="w-2 h-2 bg-orange-500 rounded-full"></span>
              Consultor IA
            </h4>
            <p class="text-sm text-orange-700 mb-3">Pregúntale a la IA sobre estrategias de reclutamiento.</p>
            <button onclick="openAIChat()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded text-sm w-full">
              Abrir Chat con IA
            </button>
          </div>
        </div>

        <!-- Área de Resultados de IA -->
        <div id="aiResults" class="bg-gray-50 rounded-lg p-4 hidden">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-bold text-gray-800">Resultados del Análisis de IA</h4>
            <button onclick="clearAIResults()" class="text-gray-500 hover:text-gray-700 text-sm">Limpiar</button>
          </div>
          <div id="aiResultsContent" class="space-y-3">
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de Debug Original -->
    <div class="bg-gray-100 rounded-lg mb-4 overflow-hidden">
      <div class="p-3 bg-gray-200 cursor-pointer flex justify-between items-center" onclick="toggleDebugPanel()">
        <h3 class="font-bold text-gray-700">Panel de Debug</h3>
        <span id="debugArrow" class="transform transition-transform">▼</span>
      </div>
      <div id="debugContent" class="p-4 hidden">
        <div id="debugInfo" class="text-sm text-gray-600 max-h-40 overflow-y-auto"></div>
        <button id="testApiBtn" class="bg-blue-500 text-white px-4 py-2 rounded mt-2 hover:bg-blue-600">
          Probar conexión a API
        </button>
        <button id="clearDebugBtn" class="bg-gray-500 text-white px-4 py-2 rounded mt-2 ml-2 hover:bg-gray-600">
          Limpiar Log
        </button>
      </div>
    </div>

    <div class="mb-6 flex gap-2">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Escribe nombre, RUT, cargo, email, teléfono, comuna, empresa o fecha..." 
        class="flex-grow p-3 border rounded-lg focus:ring focus:ring-green-300"
      />
      <button id="searchBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
        Buscar
      </button>
      <button onclick="smartSearch()" class="ai-gradient text-white px-4 py-2 rounded hover:opacity-90 flex items-center gap-2">
        <span class="w-4 h-4 bg-white rounded-full flex items-center justify-center">
          <span class="text-purple-600 text-xs font-bold">AI</span>
        </span>
        Búsqueda IA
      </button>
    </div>

    <div class="bg-gray-50 rounded-lg p-4 mb-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Candidatos Encontrados</h2>
      <div id="results" class="space-y-3"></div>
    </div>

    <div id="historialSection" class="bg-gray-50 rounded-lg p-4 hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Historial de Gestiones</h2>
        <div class="flex gap-2">
          <button id="downloadExcelBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
            Descargar Excel
          </button>
          <button id="downloadPdfBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
            Descargar PDF
          </button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm bg-white rounded-lg shadow">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-3 text-left">Nombre</th>
              <th class="p-3 text-left">RUT</th>
              <th class="p-3 text-left">Cargo</th>
              <th class="p-3 text-left">Estado</th>
              <th class="p-3 text-left">Score IA</th>
              <th class="p-3 text-left">Motivo</th>
              <th class="p-3 text-left">Fecha/Hora</th>
            </tr>
          </thead>
          <tbody id="historialBody">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Modal para Chat con IA -->
  <div id="aiChatModal" class="modal-overlay hidden">
    <div class="modal-content bg-white text-black p-6 rounded-lg shadow-xl w-full max-w-4xl relative max-h-[80vh]">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold flex items-center gap-2">
          <div class="w-6 h-6 ai-gradient rounded-full flex items-center justify-center">
            <span class="text-white text-sm font-bold">AI</span>
          </div>
          Consultor de Reclutamiento IA
        </h3>
        <button onclick="closeAIChat()" class="text-gray-600 hover:text-black text-2xl font-bold">&times;</button>
      </div>
      
      <div id="aiChatMessages" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto mb-4 space-y-3">
        <div class="ai-gradient text-white p-3 rounded-lg max-w-md">
          ¡Hola! Soy tu asistente de IA para reclutamiento. Puedo ayudarte con:
          <ul class="mt-2 text-sm">
            <li>• Análisis de candidatos</li>
            <li>• Estrategias de selección</li>
            <li>• Preguntas de entrevista</li>
            <li>• Evaluación de perfiles</li>
          </ul>
          ¿En qué puedo ayudarte hoy?
        </div>
      </div>
      
      <div class="flex gap-2">
        <input 
          type="text" 
          id="aiChatInput" 
          placeholder="Pregunta algo sobre reclutamiento..." 
          class="flex-grow p-3 border rounded-lg focus:ring focus:ring-purple-300"
        />
        <button onclick="sendAIMessage()" class="ai-gradient text-white px-6 py-3 rounded hover:opacity-90">
          Enviar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para Ficha de Postulación -->
  <div id="formularioModal" class="modal-overlay hidden">
    <div class="modal-content bg-white text-black p-6 rounded-lg shadow-xl w-full max-w-4xl relative">
      <div class="absolute top-3 right-4 flex gap-2">
        <button id="downloadFichaBtn" onclick="downloadFichaPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
          Descargar Ficha
        </button>
        <button onclick="hideApplicationForm()" class="text-gray-600 hover:text-black text-2xl font-bold leading-none">&times;</button>
      </div>

      <div id="formularioPostulacion">
        <!-- Contenido del formulario original -->
        <div class="border-2 border-black bg-white">
          <div class="flex items-center border-b-2 border-black">
            <div class="p-4 border-r-2 border-black">
              <div class="font-bold text-lg">GRUPO NORTE</div>
            </div>
            <div class="flex-1 text-center p-4">
              <div class="font-bold">FICHA DE POSTULACIÓN E INGRESO</div>
              <div class="text-sm">SELECCIÓN Y RECLUTAMIENTO</div>
            </div>
            <div class="p-4 border-l-2 border-black text-sm">
              <div>FE-06</div>
              <div>Versión: 04</div>
              <div>Fecha: 13-03-2025</div>
            </div>
          </div>

          <div class="p-4 space-y-4">
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="font-bold">Fecha de Postulación:</span>
                <span id="form-fecha-postulacion" class="ml-2 border-b border-black inline-block w-32 text-center"></span>
              </div>
              <div>
                <span class="font-bold">Cargo:</span>
                <span id="form-cargo" class="ml-2 border-b border-black inline-block w-40 text-center"></span>
              </div>
            </div>

            <div class="text-sm">
              <span class="font-bold">NOMBRE COMPLETO:</span>
              <span id="form-nombre" class="ml-2 border-b border-black inline-block w-80 text-center"></span>
            </div>
            
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div>
                <span class="font-bold">RUT:</span>
                <span id="form-rut" class="ml-2 border-b border-black inline-block w-28 text-center"></span>
              </div>
              <div>
                <span class="font-bold">Estado Civil:</span>
                <span id="form-estado-civil" class="ml-2 border-b border-black inline-block w-24 text-center"></span>
              </div>
              <div>
                <span class="font-bold">Fecha de Nacimiento:</span>
                <span id="form-fecha-nacimiento" class="ml-2 border-b border-black inline-block w-28 text-center"></span>
              </div>
            </div>

            <!-- Resto del formulario original... -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SHEETDB_API_URL = "https://sheetdb.io/api/v1/arqvckj0fb8af";
    let gestiones = [];
    let currentCandidates = [];
    let aiConversation = [];

    // Funciones del panel de IA
    function toggleAIPanel() {
      const content = document.getElementById("aiContent");
      const arrow = document.getElementById("aiArrow");
      
      if (content.classList.contains("hidden")) {
        content.classList.remove("hidden");
        arrow.style.transform = "rotate(180deg)";
      } else {
        content.classList.add("hidden");
        arrow.style.transform = "rotate(0deg)";
      }
    }

    function toggleDebugPanel() {
      const content = document.getElementById("debugContent");
      const arrow = document.getElementById("debugArrow");
      
      if (content.classList.contains("hidden")) {
        content.classList.remove("hidden");
        arrow.style.transform = "rotate(180deg)";
      } else {
        content.classList.add("hidden");
        arrow.style.transform = "rotate(0deg)";
      }
    }

    function updateDebugInfo(message) {
      const debugDiv = document.getElementById("debugInfo");
      debugDiv.innerHTML += `<div class="mb-1">${new Date().toLocaleTimeString()}: ${message}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    function clearDebugInfo() {
      document.getElementById("debugInfo").innerHTML = "";
    }

    function showAIResults() {
      document.getElementById("aiResults").classList.remove("hidden");
    }

    function clearAIResults() {
      document.getElementById("aiResults").classList.add("hidden");
      document.getElementById("aiResultsContent").innerHTML = "";
    }

    function addAIResult(title, content, type = 'info') {
      const colors = {
        'info': 'border-l-blue-500 bg-blue-50',
        'success': 'border-l-green-500 bg-green-50',
        'warning': 'border-l-yellow-500 bg-yellow-50',
        'error': 'border-l-red-500 bg-red-50'
      };

      const resultDiv = document.createElement('div');
      resultDiv.className = `border-l-4 ${colors[type]} p-4 rounded`;
      resultDiv.innerHTML = `
        <h5 class="font-bold mb-2">${title}</h5>
        <div class="text-sm">${content}</div>
      `;
      
      document.getElementById("aiResultsContent").appendChild(resultDiv);
      showAIResults();
    }

    // Análisis de candidatos con IA
    async function analyzeAllCandidates() {
      if (currentCandidates.length === 0) {
        addAIResult("Sin candidatos", "No hay candidatos para analizar. Realiza una búsqueda primero.", "warning");
        return;
      }

      addAIResult("Analizando...", "La IA está procesando los perfiles de los candidatos...", "info");

      try {
        // Simular llamada a API de IA
        await simulateAIProcessing();

        let analysis = "La IA ha analizado los candidatos y encontró:\n\n";
        
        currentCandidates.forEach((candidato, index) => {
          const score = Math.floor(Math.random() * 30) + 70; // Score aleatorio entre 70-100
          const strengths = generateStrengths(candidato);
          const concerns = generateConcerns(candidato);
          
          candidato.aiScore = score;
          
          analysis += `<div class="mb-4 p-3 border rounded">
            <div class="font-bold text-lg">${candidato.NOMBRE} ${candidato.APELLIDO}</div>
            <div class="flex items-center gap-2 mb-2">
              <span class="font-medium">Score IA:</span>
              <span class="px-2 py-1 rounded text-sm font-bold ${score >= 85 ? 'bg-green-200 text-green-800' : score >= 70 ? 'bg-yellow-200 text-yellow-800' : 'bg-red-200 text-red-800'}">${score}/100</span>
            </div>
            <div class="text-sm">
              <strong>Fortalezas:</strong> ${strengths}<br>
              <strong>Áreas de atención:</strong> ${concerns}
            </div>
          </div>`;
        });

        // Ordenar candidatos por score
        currentCandidates.sort((a, b) => (b.aiScore || 0) - (a.aiScore || 0));
        renderResults(currentCandidates);

        addAIResult("Análisis completado", analysis, "success");
        
      } catch (error) {
        addAIResult("Error en análisis", `No se pudo completar el análisis: ${error.message}`, "error");
      }
    }

    function generateStrengths(candidato) {
      const strengths = [
        "Experiencia relevante en el sector",
        "Buenas referencias laborales",
        "Disponibilidad inmediata",
        "Ubicación conveniente",
        "Perfil estable",
        "Competencias técnicas adecuadas"
      ];
      return strengths[Math.floor(Math.random() * strengths.length)];
    }

    function generateConcerns(candidato) {
      const concerns = [
        "Verificar referencias laborales",
        "Confirmar disponibilidad de horarios",
        "Evaluar expectativas salariales",
        "Revisar certificaciones",
        "Ninguna preocupación significativa"
      ];
      return concerns[Math.floor(Math.random() * concerns.length)];
    }

    // Generar preguntas de entrevista
    async function generateInterviewQuestions() {
      addAIResult("Generando preguntas...", "La IA está creando preguntas personalizadas de entrevista...", "info");
      
      try {
        await simulateAIProcessing();
        
        const questions = `
          <div class="space-y-3">
            <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-500">
              <h6 class="font-bold">Preguntas Generales</h6>
              <ul class="text-sm mt-2 space-y-1">
                <li>• ¿Qué te motivó a postular a este cargo en Grupo Norte?</li>
                <li>• ¿Cómo describirías tu experiencia previa en limpieza industrial?</li>
                <li>• ¿Estás dispuesto/a a trabajar en turnos nocturnos?</li>
              </ul>
            </div>
            
            <div class="bg-green-50 p-3 rounded border-l-4 border-green-500">
              <h6 class="font-bold">Preguntas Técnicas</h6>
              <ul class="text-sm mt-2 space-y-1">
                <li>• ¿Tienes experiencia con maquinaria de limpieza? ¿Cuáles?</li>
                <li>• ¿Cuentas con certificación OS-10 vigente?</li>
                <li>• ¿Cómo manejarías una situación de riesgo en el trabajo?</li>
              </ul>
            </div>
            
            <div class="bg-purple-50 p-3 rounded border-l-4 border-purple-500">
              <h6 class="font-bold">Preguntas Situacionales</h6>
              <ul class="text-sm mt-2 space-y-1">
                <li>• Si un compañero no cumple con sus tareas, ¿cómo reaccionarías?</li>
                <li>• ¿Cómo te organizas para cumplir con múltiples tareas?</li>
                <li>• ¿Qué harías si encuentras un problema de seguridad?</li>
              </ul>
            </div>
          </div>
        `;
        
        addAIResult("Preguntas generadas", questions, "success");
        
      } catch (error) {
        addAIResult("Error", `No se pudieron generar las preguntas: ${error.message}`, "error");
      }
    }

    // Búsqueda inteligente
    async function smartSearch() {
      const query = document.getElementById("searchInput").value;
      if (!query.trim()) {
        addAIResult("Búsqueda vacía", "Por favor ingresa un término de búsqueda.", "warning");
        return;
      }

      addAIResult("Búsqueda inteligente", "La IA está procesando tu consulta para encontrar los mejores resultados...", "info");

      try {
        await simulateAIProcessing();
        
        // Realizar búsqueda normal primero
        const result = await searchCandidates(query);
        
        if (result.success && result.data.length > 0) {
          // Aplicar ranking inteligente
          const rankedResults = result.data.map(candidato => {
            candidato.relevanceScore = calculateRelevanceScore(candidato, query);
            return candidato;
          }).sort((a, b) => b.relevanceScore - a.relevanceScore);

          currentCandidates = rankedResults;
          renderResults(rankedResults);

          addAIResult("Búsqueda completada", 
            `Se encontraron ${rankedResults.length} candidatos. Los resultados han sido ordenados por relevancia usando IA.`, 
            "success"
          );
        } else {
          addAIResult("Sin resultados", "No se encontraron candidatos que coincidan con tu búsqueda.", "warning");
        }

      } catch (error) {
        addAIResult("Error en búsqueda", `Error en la búsqueda inteligente: ${error.message}`, "error");
      }
    }

    function calculateRelevanceScore(candidato, query) {
      const queryLower = query.toLowerCase();
      let score = 0;
      
      // Puntuación basada en coincidencias exactas
      if (candidato.NOMBRE && candidato.NOMBRE.toLowerCase().includes(queryLower)) score += 10;
      if (candidato.CARGO && candidato.CARGO.toLowerCase().includes(queryLower)) score += 8;
      if (candidato.EMPRESA && candidato.EMPRESA.toLowerCase().includes(queryLower)) score += 6;
      if (candidato.COMUNA && candidato.COMUNA.toLowerCase().includes(queryLower)) score += 4;
      
      // Puntuación adicional por campos completos
      if (candidato.EMAIL) score += 2;
      if (candidato.TELEFONO) score += 2;
      if (candidato["ENLACE CV"]) score += 3;
      
      return score + Math.floor(Math.random() * 10); // Factor aleatorio para variabilidad
    }

    // Chat con IA
    function openAIChat() {
      document.getElementById("aiChatModal").classList.remove("hidden");
    }

    function closeAIChat() {
      document.getElementById("aiChatModal").classList.add("hidden");
    }

    async function sendAIMessage() {
      const input = document.getElementById("aiChatInput");
      const message = input.value.trim();
      
      if (!message) return;
      
      // Agregar mensaje del usuario
      addChatMessage(message, 'user');
      input.value = '';
      
      // Mostrar indicador de carga
      const loadingId = addChatMessage("La IA está procesando tu consulta...", 'ai', true);
      
      try {
        await simulateAIProcessing();
        
        // Simular respuesta de IA
        const response = generateAIResponse(message);
        
        // Remover indicador de carga y agregar respuesta
        document.getElementById(loadingId).remove();
        addChatMessage(response, 'ai');
        
      } catch (error) {
        document.getElementById(loadingId).remove();
        addChatMessage("Lo siento, ocurrió un error al procesar tu consulta.", 'ai');
