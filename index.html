<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Reclutamiento - Grupo Norte</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen" style="background-color:#002338;">

  <!-- üîù Header con fondo oscuro y logos -->
  <header class="w-full py-4" style="background-color:#002338;">
    <div class="max-w-5xl mx-auto flex justify-center items-center gap-6">
      <img src="https://github.com/AnalistaGn/dashboard-gn-e/blob/main/Grupo%20%5E%20Norte_%20Creamos%20.png?raw=true" 
           alt="Grupo Norte" class="h-16 object-contain" />
      <img src="https://github.com/AnalistaGn/dashboard-gn-e/blob/main/Norti%CC%81n%20Verde.png?raw=true" 
           alt="Nort√≠n Verde" class="h-16 object-contain" />
    </div>
  </header>

  <!-- Contenido principal -->
  <main class="max-w-6xl mx-auto bg-white shadow-lg rounded-xl p-6 mt-6">
    <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">üìã Sistema de Reclutamiento</h1>

    <!-- Panel de Debug desplegable -->
    <div class="bg-gray-100 rounded-lg mb-4 overflow-hidden">
      <div class="p-3 bg-gray-200 cursor-pointer flex justify-between items-center" onclick="toggleDebugPanel()">
        <h3 class="font-bold text-gray-700">üîß Panel de Debug</h3>
        <span id="debugArrow" class="transform transition-transform">‚ñº</span>
      </div>
      <div id="debugContent" class="p-4 hidden">
        <div id="debugInfo" class="text-sm text-gray-600 max-h-40 overflow-y-auto"></div>
        <button id="testApiBtn" class="bg-blue-500 text-white px-4 py-2 rounded mt-2 hover:bg-blue-600">
          üîç Probar conexi√≥n a API
        </button>
        <button id="clearDebugBtn" class="bg-gray-500 text-white px-4 py-2 rounded mt-2 ml-2 hover:bg-gray-600">
          üóëÔ∏è Limpiar Log
        </button>
      </div>
    </div>

    <!-- Input de b√∫squeda -->
    <div class="mb-6 flex gap-2">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Escribe nombre, RUT, cargo, email, tel√©fono, comuna, empresa o fecha..." 
        class="flex-grow p-3 border rounded-lg focus:ring focus:ring-green-300"
      />
      <button id="searchBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
        üîç Buscar
      </button>
    </div>

    <!-- Resultados -->
    <div class="bg-gray-50 rounded-lg p-4 mb-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Candidatos Encontrados</h2>
      <div id="results" class="space-y-3"></div>
    </div>

    <!-- Historial de Gestiones -->
    <div id="historialSection" class="bg-gray-50 rounded-lg p-4 hidden">
      <h2 class="text-xl font-bold mb-4 text-gray-800">üìä Historial de Gestiones</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm bg-white rounded-lg shadow">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-3 text-left">Nombre</th>
              <th class="p-3 text-left">RUT</th>
              <th class="p-3 text-left">Cargo</th>
              <th class="p-3 text-left">Estado</th>
              <th class="p-3 text-left">Motivo</th>
              <th class="p-3 text-left">Fecha/Hora</th>
            </tr>
          </thead>
          <tbody id="historialBody">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const SHEETDB_API_URL = "https://sheetdb.io/api/v1/arqvckj0fb8af";
    const DECISIONS_API_URL = "https://sheetdb.io/api/v1/arqvckj0fb8af"; // Para guardar decisiones
    let gestiones = [];

    // üîß Panel de Debug
    function toggleDebugPanel() {
      const content = document.getElementById("debugContent");
      const arrow = document.getElementById("debugArrow");
      
      if (content.classList.contains("hidden")) {
        content.classList.remove("hidden");
        arrow.style.transform = "rotate(180deg)";
      } else {
        content.classList.add("hidden");
        arrow.style.transform = "rotate(0deg)";
      }
    }

    function updateDebugInfo(message) {
      const debugDiv = document.getElementById("debugInfo");
      debugDiv.innerHTML += `<div class="mb-1">${new Date().toLocaleTimeString()}: ${message}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    function clearDebugInfo() {
      document.getElementById("debugInfo").innerHTML = "";
    }

    // üîß Funci√≥n para probar la API
    async function testAPI() {
      updateDebugInfo("üîÑ Iniciando prueba de API...");
      
      try {
        const response = await fetch(SHEETDB_API_URL);
        updateDebugInfo(`üì° Respuesta HTTP: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        updateDebugInfo(`‚úÖ Datos recibidos: ${data.length} registros`);
        
        if (data.length > 0) {
          updateDebugInfo(`üìã Primer registro: ${JSON.stringify(data[0])}`);
          updateDebugInfo(`üîë Campos disponibles: ${Object.keys(data[0]).join(', ')}`);
        }

        return data;
      } catch (error) {
        updateDebugInfo(`‚ùå Error: ${error.message}`);
        throw error;
      }
    }

    // üîé B√∫squeda mejorada con debug
    async function searchCandidates(query) {
      updateDebugInfo(`üîç Buscando: "${query}"`);
      
      try {
        const response = await fetch(SHEETDB_API_URL);
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const allData = await response.json();
        updateDebugInfo(`üìä Total de registros en la base: ${allData.length}`);

        const sanitizedQuery = query.trim().toLowerCase();
        updateDebugInfo(`üî§ Query procesada: "${sanitizedQuery}"`);

        const filtered = allData.filter(candidato => {
          const matches = [
            candidato.NOMBRE && candidato.NOMBRE.toLowerCase().includes(sanitizedQuery),
            candidato.APELLIDO && candidato.APELLIDO.toLowerCase().includes(sanitizedQuery),
            candidato.RUT && candidato.RUT.toLowerCase().includes(sanitizedQuery),
            candidato.CARGO && candidato.CARGO.toLowerCase().includes(sanitizedQuery),
            candidato.EMAIL && candidato.EMAIL.toLowerCase().includes(sanitizedQuery),
            candidato.TELEFONO && candidato.TELEFONO.toLowerCase().includes(sanitizedQuery),
            candidato["FECHA DE POSTULACION"] && candidato["FECHA DE POSTULACION"].toLowerCase().includes(sanitizedQuery),
            candidato.COMUNA && candidato.COMUNA.toLowerCase().includes(sanitizedQuery),
            candidato.EMPRESA && candidato.EMPRESA.toLowerCase().includes(sanitizedQuery)
          ];
          
          return matches.some(match => match === true);
        });

        updateDebugInfo(`‚úÖ Resultados filtrados: ${filtered.length} coincidencias`);
        return { success: true, data: filtered };
      } catch (error) {
        updateDebugInfo(`‚ùå Error en b√∫squeda: ${error.message}`);
        return { success: false, error: error.message };
      }
    }

    // üíæ Guardar decisi√≥n de reclutamiento
    async function saveDecision(candidato, reclutado, motivo = "") {
      updateDebugInfo(`üíæ Guardando decisi√≥n para ${candidato.NOMBRE} ${candidato.APELLIDO}`);
      
      const record = {
        nombre: `${candidato.NOMBRE || ""} ${candidato.APELLIDO || ""}`.trim(),
        rut: candidato.RUT || "N/A",
        cargo: candidato.CARGO || "N/A",
        email: candidato.EMAIL || "N/A",
        telefono: candidato.TELEFONO || "N/A",
        comuna: candidato.COMUNA || "N/A",
        empresa: candidato.EMPRESA || "N/A",
        fechaPostulacion: candidato["FECHA DE POSTULACION"] || "N/A",
        reclutado: reclutado ? "S√ç" : "NO",
        motivo: motivo || (reclutado ? "Aprobado en proceso" : "No cumple requisitos"),
        fechaRegistro: new Date().toLocaleDateString("es-CL"),
        horaRegistro: new Date().toLocaleTimeString("es-CL", {
          hour: "2-digit",
          minute: "2-digit",
        }),
      };

      try {
        // Aqu√≠ podr√≠as enviar a una hoja separada o a la misma
        // const response = await fetch(DECISIONS_API_URL, {
        //   method: "POST",
        //   headers: { "Content-Type": "application/json" },
        //   body: JSON.stringify(record),
        // });

        // Por ahora solo lo guardamos localmente
        gestiones.unshift(record);
        updateDebugInfo(`‚úÖ Decisi√≥n guardada: ${reclutado ? "RECLUTADO" : "RECHAZADO"}`);
        return { success: true };
      } catch (error) {
        updateDebugInfo(`‚ùå Error al guardar decisi√≥n: ${error.message}`);
        return { success: false, error: error.message };
      }
    }

    // üé® Renderizar resultados con botones de decisi√≥n
    function renderResults(data) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (data.length === 0) {
        resultsDiv.innerHTML = `<p class="text-gray-500">No se encontraron resultados.</p>`;
        return;
      }

      data.forEach(candidato => {
        const card = document.createElement("div");
        card.className = "p-4 rounded-lg shadow-sm text-white flex justify-between items-center";
        card.style.backgroundColor = "#77c25c";

        card.innerHTML = `
          <div class="flex-grow">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p><strong>Nombre:</strong> ${candidato.NOMBRE || "-"} ${candidato.APELLIDO || ""}</p>
                <p><strong>RUT:</strong> ${candidato.RUT || "-"}</p>
                <p><strong>Cargo:</strong> ${candidato.CARGO || "-"}</p>
                <p><strong>Email:</strong> ${candidato.EMAIL || "-"}</p>
              </div>
              <div>
                <p><strong>Tel√©fono:</strong> ${candidato.TELEFONO || "-"}</p>
                <p><strong>Comuna:</strong> ${candidato.COMUNA || "-"}</p>
                <p><strong>Empresa:</strong> ${candidato.EMPRESA || "-"}</p>
                <p><strong>Fecha Postulaci√≥n:</strong> ${candidato["FECHA DE POSTULACION"] || "-"}</p>
              </div>
            </div>
            ${candidato["ENLACE CV"] ? `<p class="mt-2"><strong>CV:</strong> <a href="${candidato["ENLACE CV"]}" target="_blank" class="underline">üìÑ Ver Curriculum</a></p>` : ""}
          </div>
          <div class="flex flex-col gap-2 ml-4">
            <button 
              onclick="handleDecision('${candidato.RUT}', true)" 
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm"
            >
              ‚úÖ Reclutar
            </button>
            <button 
              onclick="handleDecision('${candidato.RUT}', false)" 
              class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm"
            >
              ‚ùå Rechazar
            </button>
          </div>
        `;
        resultsDiv.appendChild(card);
      });
    }

    // üìä Renderizar historial
    function renderHistorial() {
      const historialBody = document.getElementById("historialBody");
      const historialSection = document.getElementById("historialSection");
      
      if (gestiones.length === 0) {
        historialSection.classList.add("hidden");
        return;
      }

      historialSection.classList.remove("hidden");
      historialBody.innerHTML = "";

      gestiones.forEach(gestion => {
        const row = document.createElement("tr");
        row.className = "border-b border-gray-200 hover:bg-gray-50";
        
        row.innerHTML = `
          <td class="p-3">${gestion.nombre}</td>
          <td class="p-3">${gestion.rut}</td>
          <td class="p-3">${gestion.cargo}</td>
          <td class="p-3">
            <span class="px-2 py-1 rounded text-xs ${gestion.reclutado === 'S√ç' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
              ${gestion.reclutado === 'S√ç' ? '‚úÖ Reclutado' : '‚ùå Rechazado'}
            </span>
          </td>
          <td class="p-3">${gestion.motivo}</td>
          <td class="p-3">${gestion.fechaRegistro} ${gestion.horaRegistro}</td>
        `;
        
        historialBody.appendChild(row);
      });
    }

    // üéØ Manejar decisiones de reclutamiento
    window.handleDecision = async function(rutCandidato, reclutado) {
      const motivo = prompt(
        reclutado ? 
        "Ingresa el motivo de la aprobaci√≥n (opcional):" : 
        "Ingresa el motivo del rechazo (opcional):"
      );
      
      if (motivo === null) return; // Usuario cancel√≥

      // Buscar el candidato en los resultados actuales
      const resultsDiv = document.getElementById("results");
      const candidatos = await searchCandidates(document.getElementById("searchInput").value);
      
      if (candidatos.success) {
        const candidato = candidatos.data.find(c => c.RUT === rutCandidato);
        
        if (candidato) {
          const result = await saveDecision(candidato, reclutado, motivo);
          
          if (result.success) {
            // Remover de resultados
            renderResults(candidatos.data.filter(c => c.RUT !== rutCandidato));
            // Actualizar historial
            renderHistorial();
            
            const mensaje = reclutado ? "Candidato reclutado exitosamente" : "Candidato rechazado";
            alert(`‚úÖ ${mensaje}`);
          } else {
            alert(`‚ùå Error al procesar decisi√≥n: ${result.error}`);
          }
        }
      }
    };

    // Event Listeners
    document.getElementById("testApiBtn").addEventListener("click", async () => {
      clearDebugInfo();
      try {
        const data = await testAPI();
        renderResults(data.slice(0, 5)); // Mostrar primeros 5 como ejemplo
      } catch (error) {
        document.getElementById("results").innerHTML = `<p class="text-red-500">‚ùå Error: ${error.message}</p>`;
      }
    });

    document.getElementById("clearDebugBtn").addEventListener("click", clearDebugInfo);

    document.getElementById("searchBtn").addEventListener("click", async () => {
      const query = document.getElementById("searchInput").value;
      if (query.length < 2) {
        document.getElementById("results").innerHTML = `<p class="text-gray-400">Escribe al menos 2 caracteres...</p>`;
        return;
      }

      const result = await searchCandidates(query);
      if (result.success) {
        renderResults(result.data);
      } else {
        document.getElementById("results").innerHTML = `<p class="text-red-500">‚ùå Error: ${result.error}</p>`;
      }
    });

    // B√∫squeda en tiempo real
    document.getElementById("searchInput").addEventListener("input", async (e) => {
      const query = e.target.value;
      if (query.length < 2) {
        document.getElementById("results").innerHTML = `<p class="text-gray-400">Escribe al menos 2 caracteres...</p>`;
        return;
      }

      const result = await searchCandidates(query);
      if (result.success) {
        renderResults(result.data);
      } else {
        document.getElementById("results").innerHTML = `<p class="text-red-500">‚ùå Error: ${result.error}</p>`;
      }
    });

    // B√∫squeda con Enter
    document.getElementById("searchInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        document.getElementById("searchBtn").click();
      }
    });

    // Inicializar
    window.addEventListener('load', () => {
      updateDebugInfo("üöÄ Sistema de Reclutamiento iniciado");
      renderHistorial();
    });
  </script>
</body>
</html>
